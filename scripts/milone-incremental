#!/bin/sh
# Executes 'milone compile' to generate files for incremental update.
#
# Command line arguments are forwarded to milone command.
#
# Environment variables:
#   MILONE: Milone command. Defaults to 'milone'.
#   TARGET_DIR: Directory of generated files.

set -eu

MILONE=${MILONE:-milone}

: $TARGET_DIR

mkdir -p $TARGET_DIR

FILES=$($MILONE compile --target-dir $TARGET_DIR "$@")

export FILES

# Delete files that exist but are not generated.
find $TARGET_DIR -type f -name '*.c' -exec basename {} \; | \
    xargs -I{} -P4 sh -c "if ! echo \"$FILES\" | grep -q '^{}$'; then rm -f $TARGET_DIR/{}; echo 'deleted {}' >&2; fi"

echo "$FILES"
