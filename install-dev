#!/bin/sh
# WARN: This script is intended to be used only by the auther.
# WARN: This script deletes currently installed milone-lang tools.
#
# Install milone command locally for development.
#
# See ./install for production.
# Generated files are same as that.

set -eu

# Somewhere in PATH.
BIN_DIR="$HOME/bin"

# Installation directory.
MILONE_HOME="$HOME/.milone"

# ------------------------------------------------
# Process
# ------------------------------------------------

ninja target/milone

# Ensure directory exists.
mkdir -p "$MILONE_HOME"

# Install native executable.
cp -bf target/milone "$MILONE_HOME/milone_native"

# Link milone-dotnet.
ln -bfs "$PWD/MiloneLang/bin/Debug/net5.0/MiloneLang" "$MILONE_HOME/bin/milone_dotnet/MiloneLang"

# Link LSP server.
ln -bfs "$PWD/milone_lsp/bin/Debug/net5.0/MiloneLsp" "$MILONE_HOME/bin/milone_lsp/MiloneLsp"

dotnet publish milone_lsp \
    --runtime linux-x64 \
    -o "$MILONE_HOME/bin/milone_lsp" \
    -nologo

# Link runtime.
test -d "$MILONE_HOME/runtime" && rm "$MILONE_HOME/runtime"
ln -sf "$PWD/runtime" "$MILONE_HOME/runtime"

# Link milone_libs.
test -d "$MILONE_HOME/milone_libs" && rm "$MILONE_HOME/milone_libs"
ln -sf "$PWD/milone_libs" "$MILONE_HOME/milone_libs"

# ------------------------------------------------
# milone script
# ------------------------------------------------

cat >"$BIN_DIR/milone" <<'END'
#!/bin/sh

# Try run native version.
MILONE_HOME="{{ MILONE_HOME }}" "{{ MILONE_HOME }}/milone_native" "$@"
CODE1=$?
test $CODE1 -eq 0 && exit 0

echo -e '\nmilone: Retrying with .NET version...\n' >&2

MILONE_HOME="{{ MILONE_HOME }}" "{{ MILONE_HOME }}/milone_dotnet/MiloneLang" "$@"
CODE2=$?
test $CODE2 -eq 0 && exit 0

echo "milone: Exited with $CODE1 (native) and $CODE2 (dotnet)"
exit 1
END

sed -i "s:{{ MILONE_HOME }}:$MILONE_HOME:g" "$BIN_DIR/milone"

chmod +x "$BIN_DIR/milone"

# ------------------------------------------------
# milone-gcc script
# ------------------------------------------------

cat >"$BIN_DIR/milone-gcc" <<'END'
#!/bin/sh

milone "$@" | gcc -std=c11 -O2 -I "{{ MILONE_HOME }}/runtime" "{{ MILONE_HOME }}/runtime/milone.c" -x c -
END

sed -i "s:{{ MILONE_HOME }}:$MILONE_HOME:g" "$BIN_DIR/milone-gcc"

chmod +x "$BIN_DIR/milone-gcc"

echo 'OK'
